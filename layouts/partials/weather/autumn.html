<!-- Autumn rain and falling leaves effects -->
<style>
  /* Realistic rain effect (autumn) */
  html.weather-rain .rain {
    position: fixed;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -2;
    pointer-events: none;
  }

  html.weather-rain .rain.back-row {
    z-index: -3;
    opacity: 0.3;
  }

  .drop {
    position: absolute;
    bottom: 100%;
    width: 15px;
    height: 60px;
    pointer-events: none;
    animation: drop linear infinite;
  }

  @keyframes drop {
    0% {
      transform: translateY(0vh);
    }
    75% {
      transform: translateY(100vh);
    }
    100% {
      transform: translateY(100vh);
    }
  }

  .stem {
    width: 1px;
    height: 60%;
    margin-left: 7px;
    background: linear-gradient(to bottom, rgba(125, 211, 252, 0), rgba(125, 211, 252, 0.6));
    animation: stem linear infinite;
  }

  @keyframes stem {
    0% {
      opacity: 1;
    }
    65% {
      opacity: 1;
    }
    75% {
      opacity: 0;
    }
    100% {
      opacity: 0;
    }
  }

  .splat {
    width: 15px;
    height: 10px;
    border-top: 2px dotted rgba(125, 211, 252, 0.5);
    border-radius: 50%;
    opacity: 1;
    transform: scale(0);
    animation: splat linear infinite;
  }

  @keyframes splat {
    0% {
      opacity: 1;
      transform: scale(0);
    }
    80% {
      opacity: 1;
      transform: scale(0);
    }
    90% {
      opacity: 0.5;
      transform: scale(1);
    }
    100% {
      opacity: 0;
      transform: scale(1.5);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .rain, .drop { animation: none !important; display: none !important; }
  }

  /* Falling leaves for autumn */
  .leaves-layer {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 1;
    contain: layout style paint;
  }

  .leaf {
    position: absolute;
    top: -10dvh;
    will-change: transform;
    transform: translate3d(0, -10dvh, 0);
    filter: drop-shadow(0 2px 1px rgba(0,0,0,.25));
    font-size: var(--size, 20px);
    animation: leaf-fall var(--fall, 12s) linear var(--delay, 0s) 1 both;
    opacity: var(--opacity, .9);
  }

  @keyframes leaf-fall {
    0%   { transform: translate3d(var(--xStart, 0vw), -10dvh, 0) rotate(0deg); }
    25%  { transform: translate3d(calc(var(--xStart, 0vw) + var(--amp, 20px)), 25dvh, 0) rotate(90deg); }
    50%  { transform: translate3d(calc(var(--xStart, 0vw) - var(--amp, 20px)), 50dvh, 0) rotate(180deg); }
    75%  { transform: translate3d(calc(var(--xStart, 0vw) + var(--amp, 20px)), 75dvh, 0) rotate(270deg); }
    100% { transform: translate3d(calc(var(--xStart, 0vw) + var(--drift, 0px)), 110dvh, 0) rotate(360deg); }
  }

  @media (prefers-reduced-motion: reduce) {
    .leaves-layer, .leaf { animation: none !important; display: none !important; }
  }
</style>

<!-- Rain layers for autumn -->
<div class="rain front-row" aria-hidden="true"></div>
<div class="rain back-row" aria-hidden="true"></div>

<!-- Falling leaves layer for autumn -->
<div class="leaves-layer" aria-hidden="true"></div>

<script>
  // Realistic rain effect for autumn
  function makeItRain() {
    const rainElements = document.querySelectorAll('.rain');
    rainElements.forEach(rain => rain.innerHTML = '');

    var increment = 0;
    var drops = "";
    var backDrops = "";

    // Adjust density based on screen width
    const isMobile = window.innerWidth <= 768;
    const maxDrops = isMobile ? 50 : 100; // Half density on mobile

    while (increment < maxDrops) {
      var randoHundo = Math.floor(Math.random() * (98 - 1 + 1) + 1);
      var randoFiver = Math.floor(Math.random() * (5 - 2 + 1) + 2);
      increment += randoFiver;

      const duration = '1.' + randoHundo;
      const delay = '0.' + randoHundo;

      drops += `<div class="drop" style="left: ${increment}%; bottom: ${(randoFiver + randoFiver - 1 + 100)}%; animation-delay: ${delay}s; animation-duration: ${duration}s;"><div class="stem" style="animation-delay: ${delay}s; animation-duration: ${duration}s;"></div><div class="splat" style="animation-delay: ${delay}s; animation-duration: ${duration}s;"></div></div>`;
      backDrops += `<div class="drop" style="right: ${increment}%; bottom: ${(randoFiver + randoFiver - 1 + 100)}%; animation-delay: ${delay}s; animation-duration: ${duration}s;"><div class="stem" style="animation-delay: ${delay}s; animation-duration: ${duration}s;"></div><div class="splat" style="animation-delay: ${delay}s; animation-duration: ${duration}s;"></div></div>`;
    }

    const frontRow = document.querySelector('.rain.front-row');
    const backRow = document.querySelector('.rain.back-row');
    if (frontRow) frontRow.innerHTML = drops;
    if (backRow) backRow.innerHTML = backDrops;
  }

  function checkRain() {
    const html = document.documentElement;
    if (html.classList.contains("weather-rain")) {
      makeItRain();
    } else {
      const rainElements = document.querySelectorAll('.rain');
      rainElements.forEach(rain => rain.innerHTML = '');
    }
  }

  // Watch for season changes
  const rainObs = new MutationObserver(checkRain);
  rainObs.observe(document.documentElement, { attributes: true, attributeFilter: ["class"] });
  checkRain(); // Initial check

  // Falling leaves for autumn
  (function () {
    const EMOJIS = ["ðŸ‚","ðŸ","ðŸƒ"];
    let layer = null;
    let intervalId = null;

    function rand(min, max) { return Math.random() * (max - min) + min; }
    function pick(arr) { return arr[(Math.random() * arr.length) | 0]; }

    function makeLeaf() {
      if (!layer) return;
      const MAX_ONSCREEN = 16;
      if (layer.childElementCount > MAX_ONSCREEN) return;

      const el = document.createElement("span");
      el.className = "leaf";
      el.textContent = pick(EMOJIS);

      const size = rand(14, 28);
      const xStart = rand(0, 100);
      const amp = rand(12, 36);
      const drift = rand(-80, 120);
      const fall = rand(9, 16);
      const delay = rand(0, 4);
      const opacity = rand(0.6, 1);

      el.style.setProperty("--size", `${size}px`);
      el.style.setProperty("--xStart", `${xStart}vw`);
      el.style.setProperty("--amp", `${amp}px`);
      el.style.setProperty("--drift", `${drift}px`);
      el.style.setProperty("--fall", `${fall}s`);
      el.style.setProperty("--delay", `${delay}s`);
      el.style.setProperty("--opacity", opacity.toFixed(2));
      el.style.left = `calc(${xStart}vw - ${size/2}px)`;

      el.addEventListener("animationend", () => el.remove(), { once: true });
      layer.appendChild(el);
    }

    function startLeaves() {
      layer = document.querySelector(".leaves-layer");
      if (!layer) return;
      if (intervalId) return;
      intervalId = setInterval(() => {
        if (Math.random() < 0.7) makeLeaf();
      }, 600);
    }

    function stopLeaves() {
      if (intervalId) clearInterval(intervalId);
      intervalId = null;
      if (layer) layer.innerHTML = "";
    }

    function checkLeaves() {
      const html = document.documentElement;
      if (html.classList.contains("weather-rain")) {
        startLeaves();
      } else {
        stopLeaves();
      }
    }

    // Watch for season changes
    const obs = new MutationObserver(checkLeaves);
    obs.observe(document.documentElement, { attributes: true, attributeFilter: ["class"] });
    checkLeaves(); // Initial check

    window.startLeaves = startLeaves;
    window.stopLeaves = stopLeaves;
  })();
</script>

